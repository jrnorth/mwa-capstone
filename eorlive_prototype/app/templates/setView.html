{% extends "layout.html" %}
{% block body %}
<div id="main_content_div">
    <div id="main_content_row">
        <div id="left_content">
            <h1>{{ setName }}</h1>
            <button id='backbutton' onclick="backToHistogram()">Back to histogram</button>
            <div id='error_table'></div>
            <div id="set_histogram"></div>
            <button type="button" onclick="downloadSet()">Download set</button>
        </div>
        <div id="comments_div" class="comments_class"></div>
    </div>
</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="../static/js/setsAndComments.js"></script>
<script src="../static/js/highcharts.js"></script>
<script type="text/javascript">
    {% include "js/histogram_utils.js" %} <!-- Because there are functions that depend on Python variables -->
</script>
<script>
    $(function() {
        renderComments('{{ setName }}');
    });

    var observation_counts = {{ observation_counts | tojson }};
    var error_counts = {{ error_counts | tojson }};
    var plot_bands = {{ plot_bands | tojson }};

    var backToHistogram = function() {
        $('#backbutton').hide();
        $('#error_table').hide();
        $('#set_histogram').show();
    };

    $(function() {
        $('#backbutton').hide();
        $('#error_table').hide();
        $('#set_histogram').html("<img src='/static/images/ajax-loader.gif' class='loading'/>");

        $("#set_histogram").highcharts('StockChart', {
            colors: [
                '#7cb5ec',
                '#FF0000',
                '#90ed7d',
                '#f7a35c',
                '#8085e9',
                '#f15c80',
                '#e4d354',
                '#8085e8',
                '#8d4653',
                '#91e8e1'
            ],
            credits: {
                enabled: false,
            },
            chart: {
                zoomType: "x",
            },
            legend: {
                enabled: true
            },
            plotOptions: {
                column: {
                    dataGrouping: {
                        groupPixelWidth: 100,
                        forced: true
                    },
                    pointPlacement: "between",
                    groupPadding: 0.1,
                    pointPadding: 0,
                    events: {
                        click: function(event) {
                            if (this.name === 'Errors') {
                                var columnLimits = getColumnRangeLimits(event, this.xAxis.series[1]);
                                var startTime = columnLimits.startTime, endTime = columnLimits.endTime;

                                $('#set_histogram').hide();
                                $('#error_table').html("<img src='/static/images/ajax-loader.gif' class='loading'/>");
                                $('#error_table').show();

                                $.ajax({
                                    type: "POST",
                                    url: "/error_table",
                                    data: {
                                        'starttime': startTime,
                                        'endtime': endTime
                                    },
                                    success: function(data) {
                                        $('#error_table').html(data);
                                        $('#backbutton').show();
                                    },
                                    error: function(xhr, ajaxOptions, thrownError) {
                                        backToHistogram();
                                    },
                                    dataType: "html"
                                });
                            }
                        }
                    }
                }
            },
            rangeSelector: {
                buttons: [{
                    type: 'second',
                    count: 1,
                    text: '1s'
                }, {
                    type: 'minute',
                    count: 1,
                    text: '1min'
                }, {
                    type: 'minute',
                    count: 60,
                    text: '1hr'
                }, {
                    type: 'day',
                    count: 1,
                    text: '1d'
                }, {
                    type: 'week',
                    count: 1,
                    text: '1w'
                }, {
                    type: 'month',
                    count: 1,
                    text: '1mo'
                }, {
                    type: 'month',
                    count: 3,
                    text: '3mo'
                }, {
                    type: 'month',
                    count: 6,
                    text: '6mo'
                }, {
                    type: 'ytd',
                    count: 1,
                    text: 'YTD'
                }, {
                    type: 'year',
                    count: 1,
                    text: '1y'
                }, {
                    type: 'all',
                    count: 1,
                    text: 'all'
                }],
                selected: 10
            },
            title: {
                text: 'Observation & Error Count'
            },
            xAxis: {
                ordinal: false,
                plotBands: plot_bands
            },
            yAxis: {
                title: {
                    text: 'Number of Observations/Errors'
                },
                min: 0,
                allowDecimals: false
            },
            series: [{
                type: 'column',
                name: 'Observations',
                data: observation_counts
            },
            {
                type: 'column',
                name: 'Errors',
                data: error_counts
            }]
        });
    });

    function saveCommentHelper() {
        var comment_text = document.getElementById("comment_text_field").value;
        if (comment_text.length > 1000) {
            alert("Please enter a string under 1000 characters. Your comment is " + (comment_text.length - 1000) + " characters too long.");
        }
        else if (!(comment_text)) //if it's empty, do nothing
        {
            //do nothing
        }
        else {
            document.getElementById('comment_text_field').value = ""; //empty the box
            saveComment({{set_id}}, comment_text);
        }
    }

    function handle(e) {
        if (e.keyCode === 13) {
            saveCommentHelper();
        }
    }

    function downloadSet() {
        window.open("/download_set?set_id={{set_id}}", '_blank');
    };
</script>
{% endblock %}
