<input id="construction_mode_checkbox" type="checkbox" onclick="clickConstructionModeCheckbox(this)">Enable set construction mode
<select id="eor_dropdown" style="float:right;" onchange="setEorData(this)">
    <option value="0">EOR0</option>
    <option value="1">EOR1</option>
</select>
<select id="low_high_dropdown" style="float:right;" onchange="setLowOrHighData(this)">
    <option value="high">High</option>
    <option value="low">Low</option>
</select>
<span style="float:right;">Data set:&nbsp;&nbsp;&nbsp;&nbsp;</span>
<div id='construction_controls'>
Start:&nbsp;<span id="start_time_label"></span>&nbsp;&nbsp;&nbsp;&nbsp;End:&nbsp;<span id="end_time_label"></span>
&nbsp;&nbsp;&nbsp;&nbsp;Click + drag:&nbsp;&nbsp;
<select id="click_drag_dropdown" onchange="setClickDragMode(this)">
    <option value="zoom">Zooms</option>
    <option value="flag">Flags</option>
</select>
<table id='set_construction_table' class='table table-striped table-bordered'>
    <thead>
        <tr>
            <th colspan="3">Flagged sub-ranges</th>
        </tr>
        <tr>
            <th>Start</th>
            <th>End</th>
            <th>Unflag</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
</div>
<script>
    var _chart;
    var inConstructionMode = false;
    var flaggedRanges = [], lowEOR0FlaggedRanges = [], highEOR0FlaggedRanges = [];
    var lowEOR1FlaggedRanges = [], highEOR1FlaggedRanges = [];
    var currentData = ['high', 0];
    var clickDragMode = 'zoom';

    $('#construction_controls').hide();

    var getCurrentDataSeries = function() {
        if (currentData[0] === 'low' && currentData[1] === '0')
            return low_eor0_counts;
        else if (currentData[0] === 'low')
            return low_eor1_counts;
        else if (currentData[0] === 'high' && currentData[1] === '0')
            return high_eor0_counts;
        else
            return high_eor1_counts;
    };

    var getCurrentFlaggedSet = function() {
        if (currentData[0] === 'low' && currentData[1] === '0')
            return lowEOR0FlaggedRanges;
        else if (currentData[0] === 'low')
            return lowEOR1FlaggedRanges;
        else if (currentData[0] === 'high' && currentData[1] === '0')
            return highEOR0FlaggedRanges;
        else
            return highEOR1FlaggedRanges;
    };

    var dataSetChanged = function() {
        _chart.series[0].setData(getCurrentDataSeries());

        if (inConstructionMode) {
            for (var i = 0; i < flaggedRanges.length; ++i) {
                _chart.xAxis[0].removePlotBand(flaggedRanges[i].id);
            }

            // Set the correct flagged ranges.
            flaggedRanges = getCurrentFlaggedSet();

            for (var i = 0; i < flaggedRanges.length; ++i) {
                _chart.xAxis[0].addPlotBand(flaggedRanges[i]);
            }

            // Update the information in the panel.
            updateRangeForConstruction();
            updateSetConstructionTable();
        } else {
            // Set the correct flagged ranges.
            flaggedRanges = getCurrentFlaggedSet();
        }
    };

    var setEorData = function(select) {
        currentData[1] = select.value;

        dataSetChanged();
    };

    var setLowOrHighData = function(select) {
        currentData[0] = select.value;

        dataSetChanged();
    };

    var setClickDragMode = function(select) {
        clickDragMode = select.value;
    };

    var clearSetConstructionData = function() {
        flaggedRanges = [];
        lowEOR0FlaggedRanges = [];
        highEOR0FlaggedRanges = [];
        lowEOR1FlaggedRanges = [];
        highEOR1FlaggedRanges = [];
    };

    var updateRangeForConstruction = function() {
        var obsAxisExtremes = _chart.xAxis[0].getExtremes(), errAxisExtremes = _chart.xAxis[1].getExtremes();
        var obsMin = obsAxisExtremes.dataMin, obsMax = obsAxisExtremes.dataMax, errMin = errAxisExtremes.dataMin,
            errMax = errAxisExtremes.dataMax;
        var minimum, maximum;

        if (obsMin > 0 && errMin > 0) {
            minimum = Math.min(obsMin, errMin);
        } else if (obsMin > 0) {
            minimum = obsMin;
        } else if (errMin > 0) {
            minimum = errMin;
        } else {
            minimum = Date.parse("{{ range_start }}");
        }

        if (obsMax > 0 && errMax > 0) {
            maximum = Math.max(obsMax, errMax);
        } else if (obsMax > 0) {
            maximum = obsMax;
        } else if (errMax > 0) {
            maximum = errMax;
        } else {
            maximum = Date.parse("{{ range_end }}");
        }

        var startDate = new Date(minimum), endDate = new Date(maximum);
        $('#start_time_label').html(startDate.toISOString());
        $('#end_time_label').html(endDate.toISOString());
    };

    var getDataIndices = function(startTime, endTime, obsSeries, errSeries) {
        var obsStartIndex = 0, obsEndIndex = obsSeries.xData.length - 1;
        var errStartIndex = 0, errEndIndex = errSeries.xData.length - 1;

        for (var i = 0; i < obsSeries.xData.length; ++i) {
            if (obsSeries.xData[i] >= startTime) {
                obsStartIndex = i;
                break;
            }
        }

        for (var i = obsStartIndex; i < obsSeries.xData.length; ++i) {
            if (obsSeries.xData[i] >= endTime) {
                obsEndIndex = i - 1;
                break;
            }
        }

        for (var i = 0; i < errSeries.xData.length; ++i) {
            if (errSeries.xData[i] >= startTime) {
                errStartIndex = i;
                break;
            }
        }

        for (var i = errStartIndex; i < errSeries.xData.length; ++i) {
            if (errSeries.xData[i] >= endTime) {
                errEndIndex = i - 1;
                break;
            }
        }

        return {
            obsStartIndex: obsStartIndex,
            obsEndIndex: obsEndIndex,
            errStartIndex: errStartIndex,
            errEndIndex: errEndIndex
        };
    };

    var flagClickAndDraggedRange = function(event) {
        flagRangeInSet(event.xAxis[0].min, event.xAxis[0].max);
    };

    var flagClickedRange = function(event, series) {
        var columnRange = getColumnRangeLimits(event, series);
        flagRangeInSet(columnRange.startTime, columnRange.endTime);
    };

    var flagRangeInSet = function(startTime, endTime) {
        var obsSeries = _chart.series[0], errSeries = _chart.series[1];

        var dataIndices = getDataIndices(startTime, endTime, obsSeries, errSeries);

        var removedObs = obsSeries.xData.slice(dataIndices.obsStartIndex, dataIndices.obsEndIndex - dataIndices.obsStartIndex + 1);

        var removedErr = errSeries.xData.slice(dataIndices.errStartIndex, dataIndices.errEndIndex - dataIndices.errStartIndex + 1);

        var plotBand = {
            id: (currentData[0] + currentData[1] + flaggedRanges.length).toString(),
            color: 'yellow',
            from: startTime,
            to: endTime
        };

        flaggedRanges.push(plotBand);

        _chart.xAxis[0].addPlotBand(plotBand);

        updateRangeForConstruction();
        updateSetConstructionTable();
    };

    var updateSetConstructionTable = function() {
        var tableHtml = "";

        for (var i = 0; i < flaggedRanges.length; ++i) {
            var flaggedRange = flaggedRanges[i];
            tableHtml += '<tr><td>' + new Date(flaggedRange.from).toISOString() + '</td><td>' + new Date(flaggedRange.to).toISOString() + '</td><td><button onclick=\'unflagRange("' + flaggedRange.id +
            '")\'>Unflag range</button></td></tr>';
        }

        $('#set_construction_table > tbody').html(tableHtml);
    };

    var unflagRange = function(flaggedRangeId) {
        for (var i = 0; i < flaggedRanges.length; ++i) {
            if (flaggedRanges[i].id === flaggedRangeId) {
                _chart.xAxis[0].removePlotBand(flaggedRangeId);
                flaggedRanges.splice(i, 1);
                break;
            }
        }

        updateRangeForConstruction();
        updateSetConstructionTable();
    };

    var clickConstructionModeCheckbox = function(checkbox) {
        inConstructionMode = checkbox.checked;
        if (inConstructionMode) { // Entering construction mode.
            $('#construction_controls').show(); // Show set construction controls.

            // Add plot bands.
            for (var i = 0; i < flaggedRanges.length; ++i) {
                _chart.xAxis[0].addPlotBand(flaggedRanges[i]);
            }

            // Update the information in the panel.
            updateRangeForConstruction();
            updateSetConstructionTable();
        } else { // Exiting construction mode.
            $('#construction_controls').hide(); // Hide set construction controls.

            // Remove plot bands.
            for (var i = 0; i < flaggedRanges.length; ++i) {
                _chart.xAxis[0].removePlotBand(flaggedRanges[i].id);
            }
        }
    };

    var getColumnRangeLimits = function(event, series) {
        var absoluteIndex = event.point.index, relativeIndex = 0;

        for (var i = 0; i < series.points.length; ++i) {
            if (series.points[i].index === absoluteIndex) {
                relativeIndex = i;
                break;
            }
        }

        var startTime = series.processedXData[relativeIndex], endTime = 0;

        if (series.closestPointRange !== undefined) {
            endTime = startTime + series.closestPointRange;
        } else if (series.processedXData.length > relativeIndex + 1) {
            endTime = series.processedXData[relativeIndex + 1];
        } else if (series.xData.length > absoluteIndex + 1) {
            endTime = series.xData[absoluteIndex + 1];
        } else {
            endTime = Date.parse("{{ range_end }}");
        }

        return { startTime: startTime, endTime: endTime };
    };
</script>
